<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>astropy.vo.samp.hub &mdash; Astropy v1.2.dev14994</title>
    
    <link rel="stylesheet" href="../../../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '1.2.dev14994',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../../../_static/astropy_logo.ico"/>
    <link rel="top" title="Astropy v1.2.dev14994" href="../../../../index.html" />
    <link rel="up" title="astropy.vo.samp" href="../samp.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../../../../_static/copybutton.js"></script>


  </head>
  <body role="document">
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../../index.html"><span id="logotext1">astro</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../../index.html">Astropy v1.2.dev14994</a>
	 &raquo;
      </li>
      <li><a href="../../../index.html" >Module code</a> &raquo;</li>
      <li><a href="../../vo.html" >astropy.vo</a> &raquo;</li>
      <li><a href="../samp.html" accesskey="U">astropy.vo.samp</a> &raquo;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for astropy.vo.samp.hub</h1><div class="highlight"><pre>
<span class="c"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">...extern.six.moves</span> <span class="kn">import</span> <span class="n">queue</span>
<span class="kn">from</span> <span class="nn">...extern.six.moves</span> <span class="kn">import</span> <span class="n">xmlrpc_client</span> <span class="k">as</span> <span class="n">xmlrpc</span>
<span class="kn">from</span> <span class="nn">...extern.six.moves.urllib.parse</span> <span class="kn">import</span> <span class="n">urlunparse</span>
<span class="kn">from</span> <span class="nn">...</span> <span class="kn">import</span> <span class="n">log</span>

<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="n">SAMP_STATUS_OK</span>
<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="n">__profile_version__</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="kn">import</span> <span class="n">SAMPWarning</span><span class="p">,</span> <span class="n">SAMPHubError</span><span class="p">,</span> <span class="n">SAMPProxyError</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">internet_on</span><span class="p">,</span> <span class="n">ServerProxyPool</span><span class="p">,</span> <span class="n">_HubAsClient</span>
<span class="kn">from</span> <span class="nn">.lockfile_helpers</span> <span class="kn">import</span> <span class="n">read_lockfile</span><span class="p">,</span> <span class="n">create_lock_file</span>

<span class="kn">from</span> <span class="nn">.standard_profile</span> <span class="kn">import</span> <span class="n">ThreadingXMLRPCServer</span>
<span class="kn">from</span> <span class="nn">.web_profile</span> <span class="kn">import</span> <span class="n">WebProfileXMLRPCServer</span><span class="p">,</span> <span class="n">web_profile_text_dialog</span>

<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="n">SSL_SUPPORT</span>

<span class="k">if</span> <span class="n">SSL_SUPPORT</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.ssl_utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">SafeTransport</span><span class="p">,</span> <span class="n">SecureXMLRPCServer</span><span class="p">,</span>
                            <span class="n">get_ssl_version_name</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;SAMPHubServer&#39;</span><span class="p">,</span> <span class="s">&#39;WebProfileDialog&#39;</span><span class="p">]</span>

<span class="n">__doctest_skip__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;SAMPHubServer.*&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="SAMPHubServer"><a class="viewcode-back" href="../../../../api/astropy.vo.samp.SAMPHubServer.html#astropy.vo.samp.SAMPHubServer">[docs]</a><span class="k">class</span> <span class="nc">SAMPHubServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SAMP Hub Server.</span>

<span class="sd">    The SSL parameters are usable only if Python has been compiled with SSL</span>
<span class="sd">    support and/or `ssl &lt;http://docs.python.org/dev/library/ssl.html&gt;`_ module</span>
<span class="sd">    is installed (available by default since Python 2.6).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    secret : str, optional</span>
<span class="sd">        The secret code to use for the SAMP lockfile. If none is is specified,</span>
<span class="sd">        the :func:`uuid.uuid1` function is used to generate one.</span>

<span class="sd">    addr : str, optional</span>
<span class="sd">        Listening address (or IP). This defaults to 127.0.0.1 if the internet</span>
<span class="sd">        is not reachable, otherwise it defaults to the host name.</span>

<span class="sd">    port : int, optional</span>
<span class="sd">        Listening XML-RPC server socket port. If left set to 0 (the default),</span>
<span class="sd">        the operating system will select a free port.</span>

<span class="sd">    lockfile : str, optional</span>
<span class="sd">        Custom lockfile name.</span>

<span class="sd">    timeout : int, optional</span>
<span class="sd">        Hub inactivity timeout. If ``timeout &gt; 0`` then the Hub automatically</span>
<span class="sd">        stops after an inactivity period longer than ``timeout`` seconds. By</span>
<span class="sd">        default ``timeout`` is set to 0 (Hub never expires).</span>

<span class="sd">    client_timeout : int, optional</span>
<span class="sd">        Client inactivity timeout. If ``client_timeout &gt; 0`` then the Hub</span>
<span class="sd">        automatically unregisters the clients which result inactive for a</span>
<span class="sd">        period longer than ``client_timeout`` seconds. By default</span>
<span class="sd">        ``client_timeout`` is set to 0 (clients never expire).</span>

<span class="sd">    mode : str, optional</span>
<span class="sd">        Defines the Hub running mode. If ``mode`` is ``&#39;single&#39;`` then the Hub</span>
<span class="sd">        runs using the standard ``.samp`` lock-file, having a single instance</span>
<span class="sd">        for user desktop session. Otherwise, if ``mode`` is ``&#39;multiple&#39;``,</span>
<span class="sd">        then the Hub runs using a non-standard lock-file, placed in</span>
<span class="sd">        ``.samp-1`` directory, of the form ``samp-hub-&lt;UUID&gt;``, where</span>
<span class="sd">        ``&lt;UUID&gt;`` is a unique UUID assigned to the hub.</span>

<span class="sd">    label : str, optional</span>
<span class="sd">        A string used to label the Hub with a human readable name. This string</span>
<span class="sd">        is written in the lock-file assigned to the ``hub.label`` token.</span>

<span class="sd">    https : bool, optional</span>
<span class="sd">        Set the Hub running on a Secure Sockets Layer connection (HTTPS). By</span>
<span class="sd">        default SSL is disabled.</span>

<span class="sd">    key_file : str, optional</span>
<span class="sd">        The path to a file containing the private key for SSL connections. If</span>
<span class="sd">        the certificate file (``cert_file``) contains the private key, then</span>
<span class="sd">        ``key_file`` can be omitted.</span>

<span class="sd">    cert_file : str, optional</span>
<span class="sd">        The path to a file containing a certificate to be used to identify the</span>
<span class="sd">        local side of the secure connection.</span>

<span class="sd">    cert_reqs : int, optional</span>
<span class="sd">        The parameter ``cert_reqs`` specifies whether a certificate is</span>
<span class="sd">        required from the client side of the connection, and whether it will</span>
<span class="sd">        be validated if provided. It must be one of the three values</span>
<span class="sd">        `ssl.CERT_NONE` (certificates ignored), `ssl.CERT_OPTIONAL` (not</span>
<span class="sd">        required, but validated if provided), or `ssl.CERT_REQUIRED` (required</span>
<span class="sd">        and validated). If the value of this parameter is not `ssl.CERT_NONE`,</span>
<span class="sd">        then the ``ca_certs`` parameter must point to a file of CA</span>
<span class="sd">        certificates.</span>

<span class="sd">    ca_certs : str, optional</span>
<span class="sd">        The path to a file containing a set of concatenated &quot;Certification</span>
<span class="sd">        Authority&quot; certificates, which are used to validate the certificate</span>
<span class="sd">        passed from the Hub end of the connection.</span>

<span class="sd">    ssl_version : int, optional</span>
<span class="sd">        The ``ssl_version`` option specifies which version of the SSL</span>
<span class="sd">        protocol to use. Typically, the server chooses a particular</span>
<span class="sd">        protocol version, and the client must adapt to the server&#39;s</span>
<span class="sd">        choice. Most of the versions are not interoperable with the</span>
<span class="sd">        other versions. If not specified, the default SSL version is</span>
<span class="sd">        taken from the default in the installed version of the Python</span>
<span class="sd">        standard `ssl` library.  See the `ssl` documentation for more</span>
<span class="sd">        information.</span>

<span class="sd">    web_profile : bool, optional</span>
<span class="sd">        Enables or disables the Web Profile support.</span>

<span class="sd">    web_profile_dialog : class, optional</span>
<span class="sd">        Allows a class instance to be specified using ``web_profile_dialog``</span>
<span class="sd">        to replace the terminal-based message with e.g. a GUI pop-up. Two</span>
<span class="sd">        `queue.Queue` instances will be added to the instance as attributes</span>
<span class="sd">        ``queue_request`` and ``queue_result``. When a request is received via</span>
<span class="sd">        the ``queue_request`` queue, the pop-up should be displayed, and a</span>
<span class="sd">        value of `True` or `False` should be added to ``queue_result``</span>
<span class="sd">        depending on whether the user accepted or refused the connection.</span>

<span class="sd">    web_port : int, optional</span>
<span class="sd">        The port to use for web SAMP. This should not be changed except for</span>
<span class="sd">        testing purposes, since web SAMP should always use port 21012.</span>

<span class="sd">    pool_size : int, optional</span>
<span class="sd">        The number of socket connections opened to communicate with the</span>
<span class="sd">        clients.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lockfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">client_timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;single&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">https</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">key_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cert_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cert_reqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">ca_certs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ssl_version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">web_profile</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">web_profile_dialog</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">web_port</span><span class="o">=</span><span class="mi">21012</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>

        <span class="c"># Generate random ID for the hub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span>

        <span class="c"># General settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_customlockfilename</span> <span class="o">=</span> <span class="n">lockfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addr</span> <span class="o">=</span> <span class="n">addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_timeout</span> <span class="o">=</span> <span class="n">client_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_size</span> <span class="o">=</span> <span class="n">pool_size</span>

        <span class="c"># Web profile specific attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile</span> <span class="o">=</span> <span class="n">web_profile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_dialog</span> <span class="o">=</span> <span class="n">web_profile_dialog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_port</span> <span class="o">=</span> <span class="n">web_port</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_server</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_callbacks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_queue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_semaphore</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># SSL general settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_https</span> <span class="o">=</span> <span class="n">https</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key_file</span> <span class="o">=</span> <span class="n">key_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cert_file</span> <span class="o">=</span> <span class="n">cert_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cert_reqs</span> <span class="o">=</span> <span class="n">cert_reqs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ca_certs</span> <span class="o">=</span> <span class="n">ca_certs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_version</span> <span class="o">=</span> <span class="n">ssl_version</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_host_name</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span>
        <span class="k">if</span> <span class="n">internet_on</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_host_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">()</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_addr</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host_name</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_host_name</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span>

        <span class="c"># XML-RPC server settings</span>
        <span class="k">if</span> <span class="n">https</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">key_file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SAMPHubError</span><span class="p">(</span><span class="s">&quot;Unable to load SSL private key file!&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cert_file</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cert_file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SAMPHubError</span><span class="p">(</span><span class="s">&quot;Unable to load SSL cert file!&quot;</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Hub set for using SSL.&quot;</span><span class="p">)</span>

        <span class="c"># Threading stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_run</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_hub_timeout</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_client_timeout</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_launched_threads</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Variables for timeout testing:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_activity_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_activity_time</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># Hub message id counter, used to create hub msg ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hub_msg_id_counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># Hub secret code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hub_secret_code_customized</span> <span class="o">=</span> <span class="n">secret</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hub_secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_secret_code</span><span class="p">()</span>

        <span class="c"># Hub public id (as SAMP client)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hub_public_id</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="c"># Client ids</span>
        <span class="c"># {private_key: (public_id, timestamp)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># Metadata per client</span>
        <span class="c"># {private_key: metadata}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># List of subscribed clients per MType</span>
        <span class="c"># {mtype: private_key list}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># List of subscribed MTypes per client</span>
        <span class="c"># {private_key: mtype list}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id2mtypes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># List of XML-RPC addresses per client</span>
        <span class="c"># {public_id: (XML-RPC address, ServerProxyPool instance)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xmlrpc_endpoints</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># Synchronous message id heap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_msg_ids_heap</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># Public ids counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_id_counter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The unique hub ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="k">def</span> <span class="nf">_register_standard_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="c"># Standard Profile only operations</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ping</span><span class="p">,</span> <span class="s">&#39;samp.hub.ping&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_xmlrpc_callback</span><span class="p">,</span> <span class="s">&#39;samp.hub.setXmlrpcCallback&#39;</span><span class="p">)</span>

        <span class="c"># Standard API operations</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="p">,</span> <span class="s">&#39;samp.hub.register&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unregister</span><span class="p">,</span> <span class="s">&#39;samp.hub.unregister&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declare_metadata</span><span class="p">,</span> <span class="s">&#39;samp.hub.declareMetadata&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata</span><span class="p">,</span> <span class="s">&#39;samp.hub.getMetadata&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declare_subscriptions</span><span class="p">,</span> <span class="s">&#39;samp.hub.declareSubscriptions&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_subscriptions</span><span class="p">,</span> <span class="s">&#39;samp.hub.getSubscriptions&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_registered_clients</span><span class="p">,</span> <span class="s">&#39;samp.hub.getRegisteredClients&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_subscribed_clients</span><span class="p">,</span> <span class="s">&#39;samp.hub.getSubscribedClients&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">,</span> <span class="s">&#39;samp.hub.notify&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_notify_all</span><span class="p">,</span> <span class="s">&#39;samp.hub.notifyAll&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">,</span> <span class="s">&#39;samp.hub.call&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_all</span><span class="p">,</span> <span class="s">&#39;samp.hub.callAll&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_and_wait</span><span class="p">,</span> <span class="s">&#39;samp.hub.callAndWait&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reply</span><span class="p">,</span> <span class="s">&#39;samp.hub.reply&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register_web_profile_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="c"># Web Profile methods like Standard Profile</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ping</span><span class="p">,</span> <span class="s">&#39;samp.webhub.ping&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unregister</span><span class="p">,</span> <span class="s">&#39;samp.webhub.unregister&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declare_metadata</span><span class="p">,</span> <span class="s">&#39;samp.webhub.declareMetadata&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata</span><span class="p">,</span> <span class="s">&#39;samp.webhub.getMetadata&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_declare_subscriptions</span><span class="p">,</span> <span class="s">&#39;samp.webhub.declareSubscriptions&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_subscriptions</span><span class="p">,</span> <span class="s">&#39;samp.webhub.getSubscriptions&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_registered_clients</span><span class="p">,</span> <span class="s">&#39;samp.webhub.getRegisteredClients&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_subscribed_clients</span><span class="p">,</span> <span class="s">&#39;samp.webhub.getSubscribedClients&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">,</span> <span class="s">&#39;samp.webhub.notify&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_notify_all</span><span class="p">,</span> <span class="s">&#39;samp.webhub.notifyAll&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">,</span> <span class="s">&#39;samp.webhub.call&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_all</span><span class="p">,</span> <span class="s">&#39;samp.webhub.callAll&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_and_wait</span><span class="p">,</span> <span class="s">&#39;samp.webhub.callAndWait&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reply</span><span class="p">,</span> <span class="s">&#39;samp.webhub.reply&#39;</span><span class="p">)</span>

        <span class="c"># Methods particularly for Web Profile</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_register</span><span class="p">,</span> <span class="s">&#39;samp.webhub.register&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_allowReverseCallbacks</span><span class="p">,</span> <span class="s">&#39;samp.webhub.allowReverseCallbacks&#39;</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_pullCallbacks</span><span class="p">,</span> <span class="s">&#39;samp.webhub.pullCallbacks&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_start_standard_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_https</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">SecureXMLRPCServer</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_addr</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_key_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cert_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cert_reqs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ca_certs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_version</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span>
                <span class="n">logRequests</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="n">prot</span> <span class="o">=</span> <span class="s">&#39;https&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">ThreadingXMLRPCServer</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_addr</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">log</span><span class="p">,</span> <span class="n">logRequests</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">prot</span> <span class="o">=</span> <span class="s">&#39;http&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="s">&quot;{0}:{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_addr</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">urlunparse</span><span class="p">((</span><span class="n">prot</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">register_introspection_functions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_standard_api</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_start_web_profile_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_result</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_semaphore</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_dialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># TODO: Some sort of duck-typing on the web_profile_dialog object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_dialog</span><span class="o">.</span><span class="n">queue_request</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_queue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_dialog</span><span class="o">.</span><span class="n">queue_result</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_result</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_server</span> <span class="o">=</span> <span class="n">WebProfileXMLRPCServer</span><span class="p">(</span>
                    <span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_port</span><span class="p">),</span> <span class="n">log</span><span class="p">,</span> <span class="n">logRequests</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_web_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_server</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_server</span><span class="o">.</span><span class="n">register_introspection_functions</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_register_web_profile_api</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_server</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Hub set to run with Web Profile support enabled.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Port {0} already in use. Impossible to run the &quot;</span>
                        <span class="s">&quot;Hub with Web Profile support.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_web_port</span><span class="p">),</span>
                        <span class="n">SAMPWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># Cleanup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_queue</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_result</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_semaphore</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_launch_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c"># Remove inactive threads</span>
        <span class="n">remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_launched_threads</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="n">remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_launched_threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="c"># Start new thread</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c"># Add to list of launched threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_launched_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_join_launched_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_launched_threads</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_timeout_test_hub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c"># keep this small to check _is_running often</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_lock</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_activity_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_activity_time</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Timeout expired, Hub is shutting down!&quot;</span><span class="p">,</span>
                                          <span class="n">SAMPWarning</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                            <span class="k">return</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">now</span>

    <span class="k">def</span> <span class="nf">_timeout_test_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">last</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c"># keep this small to check _is_running often</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_activity_time</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_activity_time</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_timeout</span>
                        <span class="ow">and</span> <span class="n">private_key</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">):</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Client </span><span class="si">%s</span><span class="s"> timeout expired!&quot;</span>
                                      <span class="o">%</span> <span class="n">private_key</span><span class="p">,</span>
                                      <span class="n">SAMPWarning</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_notify_disconnection</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_unregister</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">now</span>

    <span class="k">def</span> <span class="nf">_hub_as_client_request_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;samp.client.receiveCall&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;samp.client.receiveNotification&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_notification</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;samp.client.receiveResponse&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_response</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;samp.app.ping&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ping</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_hub_as_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">hub_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;samp.name&quot;</span><span class="p">:</span> <span class="s">&quot;Astropy SAMP Hub&quot;</span><span class="p">,</span>
                        <span class="s">&quot;samp.description.text&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span><span class="p">,</span>
                        <span class="s">&quot;author.name&quot;</span><span class="p">:</span> <span class="s">&quot;The Astropy Collaboration&quot;</span><span class="p">,</span>
                        <span class="s">&quot;samp.documentation.url&quot;</span><span class="p">:</span> <span class="s">&quot;http://docs.astropy.org/en/stable/vo/samp&quot;</span><span class="p">,</span>
                        <span class="s">&quot;samp.icon.url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">+</span> <span class="s">&quot;/samp/icon&quot;</span><span class="p">}</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_secret</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hub_public_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&quot;samp.self-id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&quot;samp.private-key&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_xmlrpc_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_declare_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">,</span> <span class="n">hub_metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_declare_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">,</span>
                                    <span class="p">{</span><span class="s">&quot;samp.app.ping&quot;</span><span class="p">:</span> <span class="p">{},</span>
                                     <span class="s">&quot;x-samp.query.by-meta&quot;</span><span class="p">:</span> <span class="p">{}})</span>

<div class="viewcode-block" id="SAMPHubServer.start"><a class="viewcode-back" href="../../../../api/astropy.vo.samp.SAMPHubServer.html#astropy.vo.samp.SAMPHubServer.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the current SAMP Hub instance and create the lock file. Hub</span>
<span class="sd">        start-up can be blocking or non blocking depending on the ``wait``</span>
<span class="sd">        parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wait : bool</span>
<span class="sd">            If `True` then the Hub process is joined with the caller, blocking</span>
<span class="sd">            the code flow. Usually `True` option is used to run a stand-alone</span>
<span class="sd">            Hub in an executable script. If `False` (default), then the Hub</span>
<span class="sd">            process runs in a separated thread. `False` is usually used in a</span>
<span class="sd">            Python shell.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPHubError</span><span class="p">(</span><span class="s">&quot;Hub is already running&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPHubError</span><span class="p">(</span><span class="s">&quot;Hub is not running but lockfile is set&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_web_profile_server</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_standard_server</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span> <span class="o">=</span> <span class="n">create_lock_file</span><span class="p">(</span><span class="n">lockfilename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_customlockfilename</span><span class="p">,</span>
                                          <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">hub_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">hub_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_hub_as_client</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_threads</span><span class="p">()</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Hub started&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wait</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_run</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_run</span> <span class="o">=</span> <span class="bp">None</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The hub parameters (which are written to the logfile)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># Keys required by standard profile</span>

        <span class="n">params</span><span class="p">[</span><span class="s">&#39;samp.secret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub_secret</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;samp.hub.xmlrpc.url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;samp.profile.version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__profile_version__</span>

        <span class="c"># Custom keys</span>

        <span class="n">params</span><span class="p">[</span><span class="s">&#39;hub.id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="n">params</span><span class="p">[</span><span class="s">&#39;hub.label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="ow">or</span> <span class="s">&quot;Hub {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">SSL_SUPPORT</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_https</span><span class="p">:</span>

            <span class="c"># Certificate request</span>
            <span class="n">cert_reqs_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;NONE&quot;</span><span class="p">,</span> <span class="s">&quot;OPTIONAL&quot;</span><span class="p">,</span> <span class="s">&quot;REQUIRED&quot;</span><span class="p">]</span>
            <span class="n">params</span><span class="p">[</span><span class="s">&#39;hub.ssl.certificate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cert_reqs_types</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cert_reqs</span><span class="p">]</span>

            <span class="c"># SSL protocol version</span>
            <span class="n">params</span><span class="p">[</span><span class="s">&#39;hub.ssl.protocol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_ssl_version_name</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_version</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_start_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_run</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_serve_forever</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_run</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_hub_timeout</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout_test_hub</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">&quot;Hub timeout test&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_hub_timeout</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_hub_timeout</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_client_timeout</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout_test_client</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s">&quot;Client timeout test&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_client_timeout</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_client_timeout</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_run</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_hub_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_hub_timeout</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_client_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_client_timeout</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_secret_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub_secret_code_customized</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub_secret_code_customized</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span>

<div class="viewcode-block" id="SAMPHubServer.stop"><a class="viewcode-back" href="../../../../api/astropy.vo.samp.SAMPHubServer.html#astropy.vo.samp.SAMPHubServer.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the current SAMP Hub instance and delete the lock file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Hub is stopping...&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_notify_shutdown</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">)):</span>
            <span class="n">lockfiledict</span> <span class="o">=</span> <span class="n">read_lockfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lockfiledict</span><span class="p">[</span><span class="s">&#39;samp.secret&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub_secret</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Reset variables</span>
        <span class="c"># TODO: What happens if not all threads are stopped after timeout?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_join_all_threads</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hub_msg_id_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hub_secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_secret_code</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hub_public_id</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id2mtypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xmlrpc_endpoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_activity_time</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Hub stopped.&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_join_all_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># In some cases, ``stop`` may be called from some of the sub-threads,</span>
        <span class="c"># so we just need to make sure that we don&#39;t try and shut down the</span>
        <span class="c"># calling thread.</span>
        <span class="n">current_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">current_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_run</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_run</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thread_run</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_hub_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_hub_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">current_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_hub_timeout</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_hub_timeout</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thread_hub_timeout</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_client_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_client_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">current_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_client_timeout</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_client_timeout</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thread_client_timeout</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_launched_threads</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an information concerning the Hub running status.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        running : bool</span>
<span class="sd">            Is the hub running?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span>

    <span class="k">def</span> <span class="nf">_serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">read_ready</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">socket</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.01</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="n">select</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Call to select() in SAMPHubServer failed: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
                              <span class="n">SAMPWarning</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">read_ready</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">handle_request</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile</span><span class="p">:</span>

                <span class="c"># We now check if there are any connection requests from the</span>
                <span class="c"># web profile, and if so, we initialize the pop-up.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_dialog</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">web_profile_text_dialog</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_result</span><span class="p">)</span>

                <span class="c"># We now check for requests over the web profile socket, and we</span>
                <span class="c"># also update the pop-up in case there are any changes.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">read_ready</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_server</span><span class="o">.</span><span class="n">socket</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.01</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">select</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Call to select() in SAMPHubServer failed: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
                                  <span class="n">SAMPWarning</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">read_ready</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_server</span><span class="o">.</span><span class="n">handle_request</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_server</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_notify_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msubs</span> <span class="o">=</span> <span class="n">SAMPHubServer</span><span class="o">.</span><span class="n">get_mtype_subtypes</span><span class="p">(</span><span class="s">&quot;samp.hub.event.shutdown&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">msubs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notify_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="p">{</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">:</span> <span class="s">&quot;samp.hub.event.shutdown&quot;</span><span class="p">,</span>
                                   <span class="s">&quot;samp.params&quot;</span><span class="p">:</span> <span class="p">{}})</span>

    <span class="k">def</span> <span class="nf">_notify_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>
        <span class="n">msubs</span> <span class="o">=</span> <span class="n">SAMPHubServer</span><span class="o">.</span><span class="n">get_mtype_subtypes</span><span class="p">(</span><span class="s">&quot;samp.hub.event.register&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">msubs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">:</span>
                <span class="n">public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]:</span>
                    <span class="c"># if key != private_key:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="p">{</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">:</span> <span class="s">&quot;samp.hub.event.register&quot;</span><span class="p">,</span>
                                  <span class="s">&quot;samp.params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="n">public_id</span><span class="p">}})</span>

    <span class="k">def</span> <span class="nf">_notify_unregister</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>
        <span class="n">msubs</span> <span class="o">=</span> <span class="n">SAMPHubServer</span><span class="o">.</span><span class="n">get_mtype_subtypes</span><span class="p">(</span><span class="s">&quot;samp.hub.event.unregister&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">msubs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">:</span>
                <span class="n">public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">private_key</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="p">{</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">:</span> <span class="s">&quot;samp.hub.event.unregister&quot;</span><span class="p">,</span>
                                      <span class="s">&quot;samp.params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="n">public_id</span><span class="p">}})</span>

    <span class="k">def</span> <span class="nf">_notify_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>
        <span class="n">msubs</span> <span class="o">=</span> <span class="n">SAMPHubServer</span><span class="o">.</span><span class="n">get_mtype_subtypes</span><span class="p">(</span><span class="s">&quot;samp.hub.event.metadata&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">msubs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">:</span>
                <span class="n">public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]:</span>
                    <span class="c"># if key != private_key:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="p">{</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">:</span> <span class="s">&quot;samp.hub.event.metadata&quot;</span><span class="p">,</span>
                                  <span class="s">&quot;samp.params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="n">public_id</span><span class="p">,</span>
                                                  <span class="s">&quot;metadata&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">private_key</span><span class="p">]}</span>
                                  <span class="p">})</span>

    <span class="k">def</span> <span class="nf">_notify_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>
        <span class="n">msubs</span> <span class="o">=</span> <span class="n">SAMPHubServer</span><span class="o">.</span><span class="n">get_mtype_subtypes</span><span class="p">(</span><span class="s">&quot;samp.hub.event.subscriptions&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">msubs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">:</span>
                <span class="n">public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="p">{</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">:</span> <span class="s">&quot;samp.hub.event.subscriptions&quot;</span><span class="p">,</span>
                                  <span class="s">&quot;samp.params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="n">public_id</span><span class="p">,</span>
                                                  <span class="s">&quot;subscriptions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id2mtypes</span><span class="p">[</span><span class="n">private_key</span><span class="p">]}</span>
                                  <span class="p">})</span>

    <span class="k">def</span> <span class="nf">_notify_disconnection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">_xmlrpc_call_disconnect</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">hub_public_id</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
            <span class="n">endpoint</span><span class="o">.</span><span class="n">samp</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">receiveNotification</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">hub_public_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

        <span class="n">msubs</span> <span class="o">=</span> <span class="n">SAMPHubServer</span><span class="o">.</span><span class="n">get_mtype_subtypes</span><span class="p">(</span><span class="s">&quot;samp.hub.disconnect&quot;</span><span class="p">)</span>
        <span class="n">public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmlrpc_endpoints</span><span class="p">[</span><span class="n">public_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">msubs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span> <span class="ow">and</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;notify disconnection to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">public_id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_launch_thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_xmlrpc_call_disconnect</span><span class="p">,</span>
                                   <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_hub_public_id</span><span class="p">,</span>
                                         <span class="p">{</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">:</span> <span class="s">&quot;samp.hub.disconnect&quot;</span><span class="p">,</span>
                                          <span class="s">&quot;samp.params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;Timeout expired!&quot;</span><span class="p">}}))</span>

    <span class="k">def</span> <span class="nf">_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;ping&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;1&quot;</span>

    <span class="k">def</span> <span class="nf">_query_by_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">public_id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">private_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">private_id</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">private_id</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">public_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_id</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">public_id_list</span>

    <span class="k">def</span> <span class="nf">_set_xmlrpc_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">xmlrpc_addr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">private_key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">:</span>
                <span class="n">public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_xmlrpc_endpoints</span><span class="p">[</span><span class="n">public_id</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">xmlrpc_addr</span><span class="p">,</span> <span class="n">_HubAsClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_as_client_request_handler</span><span class="p">))</span>
                <span class="k">return</span> <span class="s">&quot;&quot;</span>

            <span class="c"># Dictionary stored with the public id</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;set_xmlrpc_callback: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">private_key</span><span class="p">,</span>
                                                      <span class="n">xmlrpc_addr</span><span class="p">))</span>

            <span class="n">server_proxy_pool</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">SSL_SUPPORT</span> <span class="ow">and</span> <span class="n">xmlrpc_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;https&quot;</span><span class="p">:</span>

                <span class="n">transport</span> <span class="o">=</span> <span class="n">SafeTransport</span><span class="p">(</span><span class="n">key_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_file</span><span class="p">,</span>
                                          <span class="n">cert_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cert_file</span><span class="p">,</span>
                                          <span class="n">cert_reqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cert_reqs</span><span class="p">,</span>
                                          <span class="n">ca_certs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ca_certs</span><span class="p">,</span>
                                          <span class="n">ssl_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssl_version</span><span class="p">)</span>

                <span class="n">server_proxy_pool</span> <span class="o">=</span> <span class="n">ServerProxyPool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool_size</span><span class="p">,</span>
                                                    <span class="n">xmlrpc</span><span class="o">.</span><span class="n">ServerProxy</span><span class="p">,</span>
                                                    <span class="n">xmlrpc_addr</span><span class="p">,</span>
                                                    <span class="n">transport</span><span class="o">=</span><span class="n">transport</span><span class="p">,</span>
                                                    <span class="n">allow_none</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">server_proxy_pool</span> <span class="o">=</span> <span class="n">ServerProxyPool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool_size</span><span class="p">,</span>
                                                    <span class="n">xmlrpc</span><span class="o">.</span><span class="n">ServerProxy</span><span class="p">,</span>
                                                    <span class="n">xmlrpc_addr</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xmlrpc_endpoints</span><span class="p">[</span><span class="n">public_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmlrpc_addr</span><span class="p">,</span>
                                                <span class="n">server_proxy_pool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_perform_standard_register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_lock</span><span class="p">:</span>
            <span class="n">private_key</span><span class="p">,</span> <span class="n">public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_new_ids</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">public_id</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify_register</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;register: private-key = </span><span class="si">%s</span><span class="s"> and self-id = </span><span class="si">%s</span><span class="s">&quot;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">public_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;samp.self-id&quot;</span><span class="p">:</span> <span class="n">public_id</span><span class="p">,</span>
                <span class="s">&quot;samp.private-key&quot;</span><span class="p">:</span> <span class="n">private_key</span><span class="p">,</span>
                <span class="s">&quot;samp.hub-id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub_public_id</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">secret</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub_secret</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_standard_register</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># return {&quot;samp.self-id&quot;: &quot;&quot;, &quot;samp.private-key&quot;: &quot;&quot;, &quot;samp.hub-id&quot;: &quot;&quot;}</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;Bad secret code&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_new_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">private_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_id_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">public_id</span> <span class="o">=</span> <span class="s">&#39;cli#hub&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_id_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">public_id</span> <span class="o">=</span> <span class="s">&quot;cli#</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client_id_counter</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">public_id</span>

    <span class="k">def</span> <span class="nf">_unregister</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">()</span>

        <span class="n">public_key</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_notify_unregister</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_lock</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
                <span class="n">public_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;&quot;</span>

            <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id2mtypes</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id2mtypes</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">public_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmlrpc_endpoints</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmlrpc_endpoints</span><span class="p">[</span><span class="n">public_key</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_activity_time</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_activity_time</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_callbacks</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_callbacks</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_server</span><span class="o">.</span><span class="n">remove_client</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;unregister </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">public_key</span><span class="p">,</span> <span class="n">private_key</span><span class="p">))</span>

        <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_declare_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;declare_metadata: private-key = </span><span class="si">%s</span><span class="s"> metadata = </span><span class="si">%s</span><span class="s">&quot;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify_metadata</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">client_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="n">client_private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_id_to_private_key</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_metadata: private-key = </span><span class="si">%s</span><span class="s"> client-id = </span><span class="si">%s</span><span class="s">&quot;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">client_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">client_private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">client_private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;--&gt; metadata = </span><span class="si">%s</span><span class="s">&quot;</span>
                              <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">client_private_key</span><span class="p">])</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">client_private_key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Invalid client ID&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_declare_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">mtypes</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;declare_subscriptions: private-key = </span><span class="si">%s</span><span class="s"> mtypes = </span><span class="si">%s</span><span class="s">&quot;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mtypes</span><span class="p">)))</span>

            <span class="c"># remove subscription to previous mtypes</span>
            <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id2mtypes</span><span class="p">:</span>

                <span class="n">prev_mtypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id2mtypes</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">prev_mtypes</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c"># private_key is not in list</span>
                        <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_id2mtypes</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mtypes</span><span class="p">)</span>

            <span class="c"># remove duplicated MType for wildcard overwriting</span>
            <span class="n">original_mtypes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mtypes</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">original_mtypes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mtype</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">mtype2</span> <span class="ow">in</span> <span class="n">original_mtypes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">mtype2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">mtype</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> \
                           <span class="n">mtype2</span> <span class="o">!=</span> <span class="n">mtype</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">mtype2</span> <span class="ow">in</span> <span class="n">mtypes</span><span class="p">:</span>
                                <span class="k">del</span><span class="p">(</span><span class="n">mtypes</span><span class="p">[</span><span class="n">mtype2</span><span class="p">])</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;declare_subscriptions: subscriptions accepted from </span><span class="si">%s</span><span class="s"> =&gt; </span><span class="si">%s</span><span class="s">&quot;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mtypes</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">mtypes</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">private_key</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_notify_subscriptions</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_subscriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">client_id</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="n">client_private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_id_to_private_key</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">client_private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">client_private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id2mtypes</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_subscriptions: client-id = </span><span class="si">%s</span><span class="s"> mtypes = </span><span class="si">%s</span><span class="s">&quot;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="n">client_id</span><span class="p">,</span>
                                 <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id2mtypes</span><span class="p">[</span><span class="n">client_private_key</span><span class="p">])))</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id2mtypes</span><span class="p">[</span><span class="n">client_private_key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_subscriptions: client-id = </span><span class="si">%s</span><span class="s"> mtypes = &quot;</span>
                              <span class="s">&quot;missing&quot;</span> <span class="o">%</span> <span class="n">client_id</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Invalid client ID&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_registered_clients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="n">reg_clients</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pkey</span> <span class="o">!=</span> <span class="n">private_key</span><span class="p">:</span>
                    <span class="n">reg_clients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">pkey</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_registered_clients: private_key = </span><span class="si">%s</span><span class="s"> clients = </span><span class="si">%s</span><span class="s">&quot;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">reg_clients</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">reg_clients</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_subscribed_clients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">mtype</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="n">sub_clients</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">pkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pkey</span> <span class="o">!=</span> <span class="n">private_key</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_subscribed</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="n">mtype</span><span class="p">):</span>
                    <span class="n">sub_clients</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">pkey</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_subscribed_clients: private_key = </span><span class="si">%s</span><span class="s"> mtype = </span><span class="si">%s</span><span class="s"> clients = </span><span class="si">%s</span><span class="s">&quot;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">sub_clients</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">sub_clients</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="SAMPHubServer.get_mtype_subtypes"><a class="viewcode-back" href="../../../../api/astropy.vo.samp.SAMPHubServer.html#astropy.vo.samp.SAMPHubServer.get_mtype_subtypes">[docs]</a>    <span class="k">def</span> <span class="nf">get_mtype_subtypes</span><span class="p">(</span><span class="n">mtype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list containing all the possible wildcarded subtypes of MType.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mtype : str</span>
<span class="sd">            MType to be parsed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        types : list</span>
<span class="sd">            List of subtypes</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from astropy.vo.samp import SAMPHubServer</span>
<span class="sd">        &gt;&gt;&gt; SAMPHubServer.get_mtype_subtypes(&quot;samp.app.ping&quot;)</span>
<span class="sd">        [&#39;samp.app.ping&#39;, &#39;samp.app.*&#39;, &#39;samp.*&#39;, &#39;*&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">subtypes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">msubs</span> <span class="o">=</span> <span class="n">mtype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msubs</span><span class="p">)))</span>
        <span class="n">indexes</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
            <span class="n">tmp_mtype</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msubs</span><span class="p">[:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">tmp_mtype</span> <span class="o">!=</span> <span class="n">mtype</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tmp_mtype</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">tmp_mtype</span> <span class="o">=</span> <span class="n">tmp_mtype</span> <span class="o">+</span> <span class="s">&quot;.*&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp_mtype</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
            <span class="n">subtypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_mtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">subtypes</span>
</div>
    <span class="k">def</span> <span class="nf">_is_subscribed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">mtype</span><span class="p">):</span>

        <span class="n">subscribed</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">msubs</span> <span class="o">=</span> <span class="n">SAMPHubServer</span><span class="o">.</span><span class="n">get_mtype_subtypes</span><span class="p">(</span><span class="n">mtype</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">msub</span> <span class="ow">in</span> <span class="n">msubs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">msub</span><span class="p">]:</span>
                    <span class="n">subscribed</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">subscribed</span>

    <span class="k">def</span> <span class="nf">_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">recipient_id</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_subscribed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_public_id_to_private_key</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">),</span>
                                   <span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Client </span><span class="si">%s</span><span class="s"> not subscribed to MType </span><span class="si">%s</span><span class="s">&quot;</span>
                                        <span class="o">%</span> <span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">]))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_launch_thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_notify_</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span>
                                                            <span class="n">recipient_id</span><span class="p">,</span>
                                                            <span class="n">message</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_notify_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender_private_key</span><span class="p">,</span> <span class="n">recipient_public_id</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">sender_private_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">sender_public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">sender_private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;notify </span><span class="si">%s</span><span class="s"> from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&quot;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">],</span> <span class="n">sender_public_id</span><span class="p">,</span>
                         <span class="n">recipient_public_id</span><span class="p">))</span>

            <span class="n">recipient_private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_id_to_private_key</span><span class="p">(</span><span class="n">recipient_public_id</span><span class="p">)</span>
            <span class="n">arg_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">sender_public_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">samp_method_name</span> <span class="o">=</span> <span class="s">&quot;receiveNotification&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_retry_method</span><span class="p">(</span><span class="n">recipient_private_key</span><span class="p">,</span> <span class="n">recipient_public_id</span><span class="p">,</span> <span class="n">samp_method_name</span><span class="p">,</span> <span class="n">arg_params</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> notification from client </span><span class="si">%s</span><span class="s"> to client </span><span class="si">%s</span><span class="s"> failed [</span><span class="si">%s</span><span class="s">]&quot;</span>
                          <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">],</span> <span class="n">sender_public_id</span><span class="p">,</span>
                             <span class="n">recipient_public_id</span><span class="p">,</span> <span class="n">exc</span><span class="p">),</span>
                              <span class="n">SAMPWarning</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_notify_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s">&quot;samp.mtype&quot;</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;samp.mtype keyword is missing&quot;</span><span class="p">)</span>
            <span class="n">recipient_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notify_all_</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">recipient_ids</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_notify_all_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender_private_key</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>

        <span class="n">recipient_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">msubs</span> <span class="o">=</span> <span class="n">SAMPHubServer</span><span class="o">.</span><span class="n">get_mtype_subtypes</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">msubs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">sender_private_key</span><span class="p">:</span>
                        <span class="n">_recipient_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">recipient_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_recipient_id</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_launch_thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">,</span>
                                         <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sender_private_key</span><span class="p">,</span>
                                               <span class="n">_recipient_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
                                         <span class="p">)</span>

        <span class="k">return</span> <span class="n">recipient_ids</span>

    <span class="k">def</span> <span class="nf">_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">recipient_id</span><span class="p">,</span> <span class="n">msg_tag</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_subscribed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_public_id_to_private_key</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">),</span>
                                   <span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Client </span><span class="si">%s</span><span class="s"> not subscribed to MType </span><span class="si">%s</span><span class="s">&quot;</span>
                                        <span class="o">%</span> <span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">]))</span>
            <span class="n">public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">msg_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_new_hub_msg_id</span><span class="p">(</span><span class="n">public_id</span><span class="p">,</span> <span class="n">msg_tag</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_launch_thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">public_id</span><span class="p">,</span>
                                                          <span class="n">recipient_id</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span>
                                                          <span class="n">message</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">msg_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_call_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender_private_key</span><span class="p">,</span> <span class="n">sender_public_id</span><span class="p">,</span>
               <span class="n">recipient_public_id</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">sender_private_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;call </span><span class="si">%s</span><span class="s"> from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">msg_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sender_public_id</span><span class="p">,</span>
                         <span class="n">recipient_public_id</span><span class="p">,</span> <span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">]))</span>

            <span class="n">recipient_private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_id_to_private_key</span><span class="p">(</span><span class="n">recipient_public_id</span><span class="p">)</span>
            <span class="n">arg_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">sender_public_id</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">samp_methodName</span> <span class="o">=</span> <span class="s">&quot;receiveCall&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_retry_method</span><span class="p">(</span><span class="n">recipient_private_key</span><span class="p">,</span> <span class="n">recipient_public_id</span><span class="p">,</span> <span class="n">samp_methodName</span><span class="p">,</span> <span class="n">arg_params</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> call </span><span class="si">%s</span><span class="s"> from client </span><span class="si">%s</span><span class="s"> to client </span><span class="si">%s</span><span class="s"> failed [</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">]&quot;</span>
                          <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">],</span> <span class="n">msg_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">sender_public_id</span><span class="p">,</span> <span class="n">recipient_public_id</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="n">exc</span><span class="p">),</span>
                          <span class="n">SAMPWarning</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_call_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">msg_tag</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s">&quot;samp.mtype&quot;</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;samp.mtype keyword is missing in &quot;</span>
                                        <span class="s">&quot;message tagged as </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">msg_tag</span><span class="p">)</span>

            <span class="n">public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">msg_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_all_</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">public_id</span><span class="p">,</span> <span class="n">msg_tag</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_call_all_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender_private_key</span><span class="p">,</span> <span class="n">sender_public_id</span><span class="p">,</span> <span class="n">msg_tag</span><span class="p">,</span>
                   <span class="n">message</span><span class="p">):</span>

        <span class="n">msg_id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">msubs</span> <span class="o">=</span> <span class="n">SAMPHubServer</span><span class="o">.</span><span class="n">get_mtype_subtypes</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">msubs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtype2ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">sender_private_key</span><span class="p">:</span>
                        <span class="n">_msg_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_new_hub_msg_id</span><span class="p">(</span><span class="n">sender_public_id</span><span class="p">,</span>
                                                           <span class="n">msg_tag</span><span class="p">)</span>
                        <span class="n">receiver_public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">msg_id</span><span class="p">[</span><span class="n">receiver_public_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">_msg_id</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_launch_thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_</span><span class="p">,</span>
                                            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sender_private_key</span><span class="p">,</span>
                                                  <span class="n">sender_public_id</span><span class="p">,</span>
                                                  <span class="n">receiver_public_id</span><span class="p">,</span> <span class="n">_msg_id</span><span class="p">,</span>
                                                  <span class="n">message</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">msg_id</span>

    <span class="k">def</span> <span class="nf">_call_and_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">recipient_id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">msg_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">recipient_id</span><span class="p">,</span> <span class="s">&quot;samp::sync::call&quot;</span><span class="p">,</span>
                                <span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sync_msg_ids_heap</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="p">:</span>
                    <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sync_msg_ids_heap</span><span class="p">[</span><span class="n">msg_id</span><span class="p">])</span>
                    <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Timeout expired!&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sync_msg_ids_heap</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sync_msg_ids_heap</span><span class="p">[</span><span class="n">msg_id</span><span class="p">])</span>
                    <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sync_msg_ids_heap</span><span class="p">[</span><span class="n">msg_id</span><span class="p">])</span>
                    <span class="k">break</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main method that gets called for replying. This starts up an</span>
<span class="sd">        asynchronous reply thread and returns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_launch_thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_reply_</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span>
                                                           <span class="n">response</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_reply_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">responder_private_key</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">responder_private_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">msg_id</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">responder_public_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">responder_private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">counter</span><span class="p">,</span> <span class="n">hub_public_id</span><span class="p">,</span> <span class="n">recipient_public_id</span><span class="p">,</span> <span class="n">recipient_msg_tag</span> <span class="o">=</span> <span class="n">msg_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;;;&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;reply </span><span class="si">%s</span><span class="s"> from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&quot;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">responder_public_id</span><span class="p">,</span> <span class="n">recipient_public_id</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">recipient_msg_tag</span> <span class="o">==</span> <span class="s">&quot;samp::sync::call&quot;</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">msg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sync_msg_ids_heap</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sync_msg_ids_heap</span><span class="p">[</span><span class="n">msg_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">recipient_private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_id_to_private_key</span><span class="p">(</span><span class="n">recipient_public_id</span><span class="p">)</span>
                <span class="n">arg_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">responder_public_id</span><span class="p">,</span> <span class="n">recipient_msg_tag</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
                <span class="n">samp_method_name</span> <span class="o">=</span> <span class="s">&quot;receiveResponse&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_retry_method</span><span class="p">(</span><span class="n">recipient_private_key</span><span class="p">,</span> <span class="n">recipient_public_id</span><span class="p">,</span> <span class="n">samp_method_name</span><span class="p">,</span> <span class="n">arg_params</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> reply from client </span><span class="si">%s</span><span class="s"> to client </span><span class="si">%s</span><span class="s"> failed [</span><span class="si">%s</span><span class="s">]&quot;</span>
                          <span class="o">%</span> <span class="p">(</span><span class="n">recipient_msg_tag</span><span class="p">,</span> <span class="n">responder_public_id</span><span class="p">,</span>
                             <span class="n">recipient_public_id</span><span class="p">,</span> <span class="n">exc</span><span class="p">),</span>
                          <span class="n">SAMPWarning</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_retry_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipient_private_key</span><span class="p">,</span> <span class="n">recipient_public_id</span><span class="p">,</span> <span class="n">samp_method_name</span><span class="p">,</span> <span class="n">arg_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to retry a SAMP call several times.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        recipient_private_key</span>
<span class="sd">            The private key of the receiver of the call</span>
<span class="sd">        recipient_public_key</span>
<span class="sd">            The public key of the receiver of the call</span>
<span class="sd">        samp_method_name : str</span>
<span class="sd">            The name of the SAMP method to call</span>
<span class="sd">        arg_params : tuple</span>
<span class="sd">            Any additional arguments to be passed to the SAMP method</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">recipient_private_key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPHubError</span><span class="p">(</span><span class="s">&quot;Invalid client ID&quot;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">conf</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">n_retries</span><span class="p">):</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_web_profile</span> <span class="ow">and</span>
                    <span class="n">recipient_private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_callbacks</span><span class="p">):</span>

                    <span class="c"># Web Profile</span>
                    <span class="n">callback</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;samp.methodName&quot;</span><span class="p">:</span> <span class="n">samp_method_name</span><span class="p">,</span>
                                <span class="s">&quot;samp.params&quot;</span><span class="p">:</span> <span class="n">arg_params</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_callbacks</span><span class="p">[</span><span class="n">recipient_private_key</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="c"># Standard Profile</span>
                    <span class="n">hub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmlrpc_endpoints</span><span class="p">[</span><span class="n">recipient_public_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">hub</span><span class="o">.</span><span class="n">samp</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">samp_method_name</span><span class="p">)(</span><span class="n">recipient_private_key</span><span class="p">,</span> <span class="o">*</span><span class="n">arg_params</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">xmlrpc</span><span class="o">.</span><span class="n">Fault</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> XML-RPC endpoint error (attempt </span><span class="si">%d</span><span class="s">): </span><span class="si">%s</span><span class="s">&quot;</span>
                          <span class="o">%</span> <span class="p">(</span><span class="n">recipient_public_id</span><span class="p">,</span> <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="n">exc</span><span class="o">.</span><span class="n">faultString</span><span class="p">))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="c"># If we are here, then the above attempts failed</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="n">method_name</span> <span class="o">+</span> <span class="s">&quot; failed after &quot;</span> <span class="o">+</span> <span class="n">tries</span> <span class="o">+</span> <span class="s">&quot; attempts&quot;</span>
        <span class="k">raise</span> <span class="n">SAMPHubError</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_public_id_to_private_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">public_id</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">[</span><span class="n">private_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">public_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">private_key</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_get_new_hub_msg_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender_public_id</span><span class="p">,</span> <span class="n">sender_msg_id</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hub_msg_id_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="s">&quot;msg#</span><span class="si">%d</span><span class="s">;;</span><span class="si">%s</span><span class="s">;;</span><span class="si">%s</span><span class="s">;;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_msg_id_counter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub_public_id</span><span class="p">,</span>
                <span class="n">sender_public_id</span><span class="p">,</span> <span class="n">sender_msg_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_last_activity_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_activity_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">private_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client_activity_time</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_receive_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">sender_id</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_receive_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">sender_id</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">private_key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">:</span>

            <span class="k">if</span> <span class="s">&quot;samp.mtype&quot;</span> <span class="ow">in</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;samp.app.ping&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span>
                            <span class="p">{</span><span class="s">&quot;samp.status&quot;</span><span class="p">:</span> <span class="n">SAMP_STATUS_OK</span><span class="p">,</span> <span class="s">&quot;samp.result&quot;</span><span class="p">:</span> <span class="p">{}})</span>

            <span class="k">elif</span> <span class="p">(</span><span class="s">&quot;samp.mtype&quot;</span> <span class="ow">in</span> <span class="n">message</span> <span class="ow">and</span>
                 <span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;x-samp.query.by-meta&quot;</span> <span class="ow">or</span>
                  <span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.mtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;samp.query.by-meta&quot;</span><span class="p">)):</span>

                <span class="n">ids_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_by_metadata</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.params&quot;</span><span class="p">][</span><span class="s">&quot;key&quot;</span><span class="p">],</span>
                                                   <span class="n">message</span><span class="p">[</span><span class="s">&quot;samp.params&quot;</span><span class="p">][</span><span class="s">&quot;value&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hub_private_key</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">,</span>
                            <span class="p">{</span><span class="s">&quot;samp.status&quot;</span><span class="p">:</span> <span class="n">SAMP_STATUS_OK</span><span class="p">,</span>
                             <span class="s">&quot;samp.result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;ids&quot;</span><span class="p">:</span> <span class="n">ids_list</span><span class="p">}})</span>

            <span class="k">return</span> <span class="s">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_receive_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">responder_id</span><span class="p">,</span> <span class="n">msg_tag</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_web_profile_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identity_info</span><span class="p">,</span>
                              <span class="n">client_address</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                              <span class="n">origin</span><span class="o">=</span><span class="s">&quot;unknown&quot;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;Request of registration rejected &quot;</span>
                                      <span class="s">&quot;by the Hub.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">origin</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">identity_info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c"># an old version of the protocol provided just a string with the app name</span>
            <span class="k">if</span> <span class="s">&quot;samp.name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">identity_info</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;Request of registration rejected &quot;</span>
                                          <span class="s">&quot;by the Hub (application name not &quot;</span>
                                          <span class="s">&quot;provided).&quot;</span><span class="p">)</span>

        <span class="c"># Red semaphore for the other threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_semaphore</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;wait&quot;</span><span class="p">)</span>
        <span class="c"># Set the request to be displayed for the current thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">identity_info</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span>
                                              <span class="n">origin</span><span class="p">))</span>
        <span class="c"># Get the popup dialogue response</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="c"># OK, semaphore green</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_requests_semaphore</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">register_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_standard_register</span><span class="p">()</span>
            <span class="n">translator_url</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;http://localhost:</span><span class="si">%d</span><span class="s">/translator/</span><span class="si">%s</span><span class="s">?ref=&quot;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_web_port</span><span class="p">,</span> <span class="n">register_map</span><span class="p">[</span><span class="s">&quot;samp.private-key&quot;</span><span class="p">]))</span>
            <span class="n">register_map</span><span class="p">[</span><span class="s">&quot;samp.url-translator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translator_url</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_server</span><span class="o">.</span><span class="n">add_client</span><span class="p">(</span><span class="n">register_map</span><span class="p">[</span><span class="s">&quot;samp.private-key&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">register_map</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;Request of registration rejected by &quot;</span>
                                      <span class="s">&quot;the user.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_web_profile_allowReverseCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">allow</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">allow</span> <span class="o">==</span> <span class="s">&quot;0&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_callbacks</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_callbacks</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_callbacks</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_web_profile_pullCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">timeout_secs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_last_activity_time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">private_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_keys</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">callback_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_web_profile_callbacks</span><span class="p">[</span><span class="n">private_key</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>
                    <span class="n">item_queued</span> <span class="o">=</span> <span class="n">callback_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                    <span class="n">callback</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_queued</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">callback</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SAMPProxyError</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;Private-key </span><span class="si">%s</span><span class="s"> expired or invalid.&quot;</span>
                                    <span class="o">%</span> <span class="n">private_key</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebProfileDialog"><a class="viewcode-back" href="../../../../api/astropy.vo.samp.WebProfileDialog.html#astropy.vo.samp.WebProfileDialog">[docs]</a><span class="k">class</span> <span class="nc">WebProfileDialog</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A base class to make writing Web Profile GUI consent dialogs</span>
<span class="sd">    easier.</span>

<span class="sd">    The concrete class must:</span>

<span class="sd">        1) Poll ``handle_queue`` periodically, using the timer services</span>
<span class="sd">           of the GUI&#39;s event loop.  This function will call</span>
<span class="sd">           ``self.show_dialog`` when a request requires authorization.</span>
<span class="sd">           ``self.show_dialog`` will be given the arguments:</span>

<span class="sd">              - ``samp_name``: The name of the application making the request.</span>

<span class="sd">              - ``details``: A dictionary of details about the client</span>
<span class="sd">                making the request.</span>

<span class="sd">              - ``client``: A hostname, port pair containing the client</span>
<span class="sd">                address.</span>

<span class="sd">              - ``origin``: A string containing the origin of the</span>
<span class="sd">                request.</span>

<span class="sd">        2) Call ``consent`` or ``reject`` based on the user&#39;s response to</span>
<span class="sd">           the dialog.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WebProfileDialog.handle_queue"><a class="viewcode-back" href="../../../../api/astropy.vo.samp.WebProfileDialog.html#astropy.vo.samp.WebProfileDialog.handle_queue">[docs]</a>    <span class="k">def</span> <span class="nf">handle_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_request</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>  <span class="c"># queue is set but empty</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c"># queue has not been set yet</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>  <span class="c"># To support the old protocol version</span>
                <span class="n">samp_name</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">samp_name</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;samp.name&quot;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">show_dialog</span><span class="p">(</span><span class="n">samp_name</span><span class="p">,</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="WebProfileDialog.consent"><a class="viewcode-back" href="../../../../api/astropy.vo.samp.WebProfileDialog.html#astropy.vo.samp.WebProfileDialog.consent">[docs]</a>    <span class="k">def</span> <span class="nf">consent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_result</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WebProfileDialog.reject"><a class="viewcode-back" href="../../../../api/astropy.vo.samp.WebProfileDialog.html#astropy.vo.samp.WebProfileDialog.reject">[docs]</a>    <span class="k">def</span> <span class="nf">reject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_result</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2011-2016, The Astropy Developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1. &nbsp;
    Last built 11 May 2016. <br/>
  </p>
</footer>
  </body>
</html>