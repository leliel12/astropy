<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>C or Cython Extensions &mdash; Astropy v1.2.dev14997</title>
    
    <link rel="stylesheet" href="../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.2.dev14997',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../_static/astropy_logo.ico"/>
    <link rel="top" title="Astropy v1.2.dev14997" href="../index.html" />
    <link rel="next" title="Release Procedures" href="releasing.html" />
    <link rel="prev" title="Building Astropy and its Subpackages" href="building.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../_static/copybutton.js"></script>


  </head>
  <body role="document">
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"><span id="logotext1">astro</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="releasing.html" title="Release Procedures">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="building.html" title="Building Astropy and its Subpackages">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../index.html">Astropy v1.2.dev14997</a>
	 &raquo;
      </li>
      
      <li>C or Cython Extensions</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="c-or-cython-extensions">
<span id="building-c-or-cython-extensions"></span><h1>C or Cython Extensions<a class="headerlink" href="#c-or-cython-extensions" title="Permalink to this headline">¶</a></h1>
<p>Astropy supports using C extensions for wrapping C libraries and Cython for
speeding up computationally-intensive calculations. Both Cython and C extension
building can be customized using the <code class="docutils literal"><span class="pre">get_extensions</span></code> function of the
<code class="docutils literal"><span class="pre">setup_package.py</span></code> file. If defined, this function must return a list of
<a class="reference external" href="http://docs.python.org/distutils/apiref.html#distutils.core.Extension" title="(in Python v2.7)"><code class="xref py py-obj docutils literal"><span class="pre">distutils.core.Extension</span></code></a> objects. The creation process is left to the
subpackage designer, and can be customized however is relevant for the
extensions in the subpackage.</p>
<p>While C extensions must always be defined through the <code class="docutils literal"><span class="pre">get_extensions</span></code>
mechanism, Cython files (ending in <code class="docutils literal"><span class="pre">.pyx</span></code>) are automatically located and
loaded in separate extensions if they are not in <code class="docutils literal"><span class="pre">get_extensions</span></code>. For
Cython extensions located in this way, headers for numpy C functions are
included in the build, but no other external headers are included. <code class="docutils literal"><span class="pre">.pyx</span></code>
files present in the extensions returned by <code class="docutils literal"><span class="pre">get_extensions</span></code> are not
included in the list of extensions automatically generated extensions. Note
that this allows disabling a Cython file by providing an extension that
includes the Cython file, but giving it the special <code class="docutils literal"><span class="pre">name</span></code> &#8216;cython_skip&#8217;. Any
extension with this package name will not be built by <code class="docutils literal"><span class="pre">setup.py</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If an <a class="reference external" href="http://docs.python.org/distutils/apiref.html#distutils.core.Extension" title="(in Python v2.7)"><code class="xref py py-class docutils literal"><span class="pre">Extension</span></code></a> object is provided for Cython
source files using the <code class="docutils literal"><span class="pre">get_extensions</span></code> mechanism, it is very
important that the <code class="docutils literal"><span class="pre">.pyx</span></code> files be given as the <code class="docutils literal"><span class="pre">source</span></code>, rather than the
<code class="docutils literal"><span class="pre">.c</span></code> files generated by Cython.</p>
</div>
<div class="section" id="using-numpy-c-headers">
<h2>Using Numpy C headers<a class="headerlink" href="#using-numpy-c-headers" title="Permalink to this headline">¶</a></h2>
<p>If your C or Cython extensions uses <a class="reference external" href="http://docs.scipy.org/doc/numpy/reference/index.html#module-numpy" title="(in NumPy v1.10)"><code class="xref py py-obj docutils literal"><span class="pre">numpy</span></code></a> at the C level, you probably
need access to the numpy C headers.  A common idiom you can find in the numpy
docs or other examples involves getting the include directory by calling
<code class="docutils literal"><span class="pre">numpy.get_include()</span></code>.  However, using this in <code class="docutils literal"><span class="pre">setup_package.py</span></code> will <em>not</em>
work, because <code class="docutils literal"><span class="pre">setup_package.py</span></code> needs to be able to import even when none of
the dependencies are present.  To work around this need, simply include the
string <code class="docutils literal"><span class="pre">'numpy'</span></code> in the list that is passed to the <code class="docutils literal"><span class="pre">include_dirs</span></code> argument
of <a class="reference external" href="http://docs.python.org/distutils/apiref.html#distutils.core.Extension" title="(in Python v2.7)"><code class="xref py py-obj docutils literal"><span class="pre">distutils.core.Extension</span></code></a>.  The astropy setup helpers will then use
<code class="docutils literal"><span class="pre">numpy.get_include()</span></code> downstream once it is certain that the dependencies
have actually been processed.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">distutils.extension</span> <span class="kn">import</span> <span class="n">Extension</span>

<span class="k">def</span> <span class="nf">get_extensions</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Extension</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;myextension&#39;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;myext.pyx&#39;</span><span class="p">],</span>
                     <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;numpy&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="installing-c-header-files">
<h2>Installing C header files<a class="headerlink" href="#installing-c-header-files" title="Permalink to this headline">¶</a></h2>
<p>If your C extension needs to be linked from other third-party C code,
you probably want to install its header files along side the Python module.</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Create an <code class="docutils literal"><span class="pre">include</span></code> directory inside of your package for
all of the header files.</p>
</li>
<li><p class="first">Use the <code class="docutils literal"><span class="pre">get_package_data</span></code> hook in <code class="docutils literal"><span class="pre">setup_package.py</span></code> to
install those header files.  For example, the <a class="reference internal" href="../wcs/index.html#module-astropy.wcs" title="astropy.wcs"><code class="xref py py-obj docutils literal"><span class="pre">astropy.wcs</span></code></a>
package has this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_package_data</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;astropy.wcs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;include/*.h&#39;</span><span class="p">]}</span>
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="preventing-importing-at-build-time">
<h2>Preventing importing at build time<a class="headerlink" href="#preventing-importing-at-build-time" title="Permalink to this headline">¶</a></h2>
<p>In rare cases, some packages may need to be imported at build time.
Unfortunately, anything that requires a C or Cython extension will fail to
import until the build phase has completed. In this cases, the
<code class="docutils literal"><span class="pre">_ASTROPY_SETUP_</span></code> variable can be used to determine if the package is being
imported as part of the build and choose to not import problematic modules.
<code class="docutils literal"><span class="pre">_ASTROPY_SETUP_</span></code> is inserted into the builtins, and is <a class="reference external" href="http://docs.python.org/library/constants.html#True" title="(in Python v2.7)"><code class="xref py py-obj docutils literal"><span class="pre">True</span></code></a> when inside
of astropy&#8217;s <code class="docutils literal"><span class="pre">setup.py</span></code> script, and <a class="reference external" href="http://docs.python.org/library/constants.html#False" title="(in Python v2.7)"><code class="xref py py-obj docutils literal"><span class="pre">False</span></code></a> otherwise.</p>
<p>For example, suppose there is a subpackage <code class="docutils literal"><span class="pre">foo</span></code> that needs to
import a module called <code class="docutils literal"><span class="pre">version.py</span></code> at build time in order to set
some version information, and also has a C extension, <code class="docutils literal"><span class="pre">process</span></code>,
that will not be available in the source tree.  In this case,
<code class="docutils literal"><span class="pre">astropy/foo/__init__.py</span></code> would probably want to check the value of
<code class="docutils literal"><span class="pre">_ASTROPY_SETUP_</span></code> before importing the C extension:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">process</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_ASTROPY_SETUP_</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">version</span>
</pre></div>
</div>
</div>
<div class="section" id="speed-up-your-builds-with-ccache">
<h2>Speed up your builds with ccache<a class="headerlink" href="#speed-up-your-builds-with-ccache" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Ccache">ccache</a> is a tool that caches
compiled sources so that they don&#8217;t have to be recompiled (so long as they are
unchanged) even if the outputs have been deleted.  This means that if you
switch branches or clean your source checkout you can save a lot of time by
avoiding the majority of re-compiles from scratch.</p>
<p>Because installation and configuration of ccache varies from platform to
platform, please consult the ccache documentation and/or Google to set up
ccache on your system&#8211;this is strongly encouraged for anyone doing signficant
development of Astropy or scientific programming in general.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">C or Cython Extensions</a><ul>
<li><a class="reference internal" href="#using-numpy-c-headers">Using Numpy C headers</a></li>
<li><a class="reference internal" href="#installing-c-header-files">Installing C header files</a></li>
<li><a class="reference internal" href="#preventing-importing-at-build-time">Preventing importing at build time</a></li>
<li><a class="reference internal" href="#speed-up-your-builds-with-ccache">Speed up your builds with ccache</a></li>
</ul>
</li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="http://github.com/astropy/astropy/tree/master/docs/development/ccython.rst">Edit This Page on Github</a> &nbsp;
    <a href="../_sources/development/ccython.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2011-2016, The Astropy Developers.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1. &nbsp;
    Last built 12 May 2016. <br/>
  </p>
</footer>
  </body>
</html>